<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/pico.min.css">
    <title>Fair Coin Flip</title>
    <style>
        body { padding-top: 1rem; }
        
        @keyframes coinFlipHeads {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1800deg); }
        }
        
        @keyframes coinFlipTails {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(1980deg); }
        }
        
        .coin-container {
            display: inline-block;
            perspective: 1000px;
            vertical-align: middle;
        }
        
        .coin-flip {
            display: inline-block;
            position: relative;
            width: 3rem;
            height: 3rem;
            transform-style: preserve-3d;
        }
        
        .coin-flip-heads {
            animation: coinFlipHeads 5s ease-out forwards;
        }
        
        .coin-flip-tails {
            animation: coinFlipTails 5s ease-out forwards;
        }
        
        .coin-flip img {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
        }
        
        .coin-flip .tails-side {
            transform: rotateY(180deg);
        }
        
        .fullscreen-flip {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .fullscreen-flip.fade-out {
            opacity: 0;
        }
        
        .fullscreen-flip .coin-container {
            perspective: 2000px;
        }
        
        .fullscreen-flip .coin-flip {
            width: 20rem;
            height: 20rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div id="app"></div>
        <footer style="margin-top: 3rem; text-align: center; font-size: 0.9rem; color: #666;">
            Made in 2025 with ❤️ by <a href="https://www.alech.de">Alexander Klink</a> using <a href="https://ampcode.com/threads/T-c94c1ea0-2e80-4fe3-be3e-bd75d4bb1b55">Amp</a>.
        </footer>
    </div>

    <script>
        const HEADS = 0;
        const TAILS = 1;

        function generateSessionId() {
            return Math.random().toString(36).substring(2, 15);
        }

        function secureCoinFlip() {
            const array = new Uint8Array(1);
            crypto.getRandomValues(array);
            return array[0] % 2;
        }

        function generateRandomNumber() {
            const array = new Uint8Array(40);
            crypto.getRandomValues(array);
            
            let number = '';
            number += (array[0] % 9) + 1; // First digit 1-9
            for (let i = 1; i < 40; i++) {
                number += array[i] % 10;
            }
            return number;
        }

        function setLastDigitByCoinFlip(number, flip) {
            const numStr = number.substring(0, 39);
            const lastDigit = flip === HEADS ? 0 : 1; // Even for heads, odd for tails
            return numStr + lastDigit;
        }

        function getFlipFromNumber(number) {
            const lastDigit = parseInt(number.charAt(39));
            return lastDigit % 2 === 0 ? HEADS : TAILS;
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function xorFlips(flip1, flip2) {
            return flip1 === flip2 ? HEADS : TAILS;
        }

        function flipToString(flip) {
            return flip === HEADS ? 'HEADS' : 'TAILS';
        }

        function flipToHtml(flip, animated = false) {
            const label = flipToString(flip);
            const img = flip === HEADS ? 'img/heads.png' : 'img/tails.png';
            const animClass = animated ? 'coin-flip' : '';
            return `<img src="${img}" alt="${label}" class="${animClass}" style="height: 3rem; vertical-align: middle;"> <strong>${label}</strong>`;
        }

        function showFlippingCoin() {
            return `
                <div class="coin-container">
                    <div class="coin-flip">
                        <img src="img/heads.png" alt="Heads" class="heads-side">
                        <img src="img/tails.png" alt="Tails" class="tails-side">
                    </div>
                </div>
                <strong>Flipping...</strong>
            `;
        }

        function showFullscreenFlippingCoin(result) {
            const animClass = result === HEADS ? 'coin-flip-heads' : 'coin-flip-tails';
            return `
                <div class="fullscreen-flip">
                    <div class="coin-container">
                        <div class="coin-flip ${animClass}">
                            <img src="img/heads.png" alt="Heads" class="heads-side">
                            <img src="img/tails.png" alt="Tails" class="tails-side">
                        </div>
                    </div>
                </div>
            `;
        }

        function parseUrlParams() {
            const hashParams = window.location.hash.substring(1);
            const params = new URLSearchParams(hashParams);
            return {
                sessionId: params.get('session'),
                hash: params.get('hash'),
                bobFlip: params.get('bobFlip'),
                aliceNumber: params.get('aliceNumber')
            };
        }

        function showLanding() {
            return `
                <h1>Cryptographic Fair Coin Flip</h1>
                <p>Nearly 25 years ago, I picked up a copy of <a href="https://www.schneier.com/books/applied-cryptography">Applied Cryptography</a>
                    by Bruce Schneier. One of the parts I liked most was that there were a lot of fun, unusual protocols which go way beyond the
                    <i>usual</i> usage of cryptography (encryption, signing, hashing, etc.).
                </p>
                <p>One of these is the fair coin flip protocol, here is how it works:</p>
                <ol>
                    <li>Alice flips a coin, represents it as a large number (even = heads, odd = tails) and commits to it using a cryptographic hash</li>
                    <li>Bob receives the hash and flips their own coin and sends their flip to Alice</li>
                    <li>Alice reveals their original flip</li>
                    <li>Bob can now verify that Alice's original flip number hashes to the hash they received, which means Alice cannot cheat</li>
                    <li>Both flips are combined using XOR to produce the final result</li>
                </ol>
                <button onclick="startCoinFlip()">Start Fair Coin Flip</button>
            `;
        }

        async function initAlice() {
            const sessionId = generateSessionId();
            const aliceFlip = secureCoinFlip();
            let aliceNumber = generateRandomNumber();
            aliceNumber = setLastDigitByCoinFlip(aliceNumber, aliceFlip);
            const hash = await sha256(aliceNumber);

            sessionStorage.setItem(`session_${sessionId}_aliceNumber`, aliceNumber);
            sessionStorage.setItem(`session_${sessionId}_aliceFlip`, aliceFlip);
            sessionStorage.setItem(`session_${sessionId}_hash`, hash);

            const bobUrl = `${window.location.origin}${window.location.pathname}#session=${sessionId}&hash=${hash}`;

            return `
                <h1>Your Coin Flip</h1>
                <p>Your flip: ${flipToHtml(aliceFlip)}</p>
                <p>Your secret number: ${aliceNumber}</p>
                <p>SHA256("${aliceNumber}") = ${hash}</p>
                <h2>Send this link to your coin flip partner:</h2>
                <p><a href="${bobUrl}">${bobUrl}</a></p>
            `;
        }

        async function initAliceWithFlip(aliceFlip) {
            const sessionId = generateSessionId();
            let aliceNumber = generateRandomNumber();
            aliceNumber = setLastDigitByCoinFlip(aliceNumber, aliceFlip);
            const hash = await sha256(aliceNumber);

            sessionStorage.setItem(`session_${sessionId}_aliceNumber`, aliceNumber);
            sessionStorage.setItem(`session_${sessionId}_aliceFlip`, aliceFlip);
            sessionStorage.setItem(`session_${sessionId}_hash`, hash);

            const bobUrl = `${window.location.origin}${window.location.pathname}#session=${sessionId}&hash=${hash}`;

            return `
                <h1>Your Coin Flip</h1>
                <p>Your flip: ${flipToHtml(aliceFlip)}</p>
                <p>Your secret number: ${aliceNumber}</p>
                <p>SHA256("${aliceNumber}") = ${hash}</p>
                <h2>Send this link to your coin flip partner:</h2>
                <p><a href="${bobUrl}">${bobUrl}</a></p>
            `;
        }

        async function startCoinFlip() {
            const aliceFlip = secureCoinFlip();
            
            document.body.insertAdjacentHTML('beforeend', showFullscreenFlippingCoin(aliceFlip));
            
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const content = await initAliceWithFlip(aliceFlip);
            document.getElementById('app').innerHTML = content;
            
            const flipElement = document.querySelector('.fullscreen-flip');
            if (flipElement) {
                flipElement.classList.add('fade-out');
                await new Promise(resolve => setTimeout(resolve, 500));
                flipElement.remove();
            }
        }

        function handleBob(sessionId, hash) {
            sessionStorage.setItem(`session_${sessionId}_hash`, hash);

            return `
                <h1>Fair Coin Flip</h1>
                <p>You have been invited to participate in a cryptographic fair coin flip protocol.</p>
                <p>Your coin flip partner has committed to their flip with the SHA256 hash: ${hash}</p>
                <button onclick="bobFlip('${sessionId}')">Flip Coin</button>
                <div id="bobResult" style="margin-top: 2rem;"></div>
            `;
        }

        async function bobFlip(sessionId) {
            const bobFlipValue = secureCoinFlip();
            
            document.body.insertAdjacentHTML('beforeend', showFullscreenFlippingCoin(bobFlipValue));

            await new Promise(resolve => setTimeout(resolve, 5000));
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            sessionStorage.setItem(`session_${sessionId}_bobFlip`, bobFlipValue);

            const aliceUrl = `${window.location.origin}${window.location.pathname}#session=${sessionId}&bobFlip=${bobFlipValue}`;

            document.getElementById('bobResult').innerHTML = `
                <p>Your flip: ${flipToHtml(bobFlipValue)}</p>
                <h2>Send this link back to your coin flip partner:</h2>
                <p><a href="${aliceUrl}">${aliceUrl}</a></p>
            `;
            
            const flipElement = document.querySelector('.fullscreen-flip');
            if (flipElement) {
                flipElement.classList.add('fade-out');
                await new Promise(resolve => setTimeout(resolve, 500));
                flipElement.remove();
            }
        }

        function handleAliceSeeBobFlip(sessionId, bobFlip) {
            const aliceFlip = parseInt(sessionStorage.getItem(`session_${sessionId}_aliceFlip`));
            const aliceNumber = sessionStorage.getItem(`session_${sessionId}_aliceNumber`);
            const finalFlip = xorFlips(aliceFlip, parseInt(bobFlip));

            return `
                <h1>Combined Result</h1>
                <p>Your flip: ${flipToHtml(aliceFlip)}</p>
                <p>Your partner's flip: ${flipToHtml(parseInt(bobFlip))}</p>
                <p>Combined result: ${flipToHtml(finalFlip)}</p>
                <h2>Send this link back to your flip partner to reveal your number:</h2>
                <p><a href="${window.location.origin}${window.location.pathname}#session=${sessionId}&aliceNumber=${aliceNumber}">${window.location.origin}${window.location.pathname}#session=${sessionId}&aliceNumber=${aliceNumber}</a></p>
            `;
        }

        async function handleReveal(sessionId, aliceNumber) {
            const storedHash = sessionStorage.getItem(`session_${sessionId}_hash`);
            const computedHash = await sha256(aliceNumber);

            if (storedHash !== computedHash) {
                return `<h1>VERIFICATION FAILED!</h1><p>The number doesn't match the committed hash. Your partner may be trying to cheat!</p>`;
            }

            const aliceFlip = getFlipFromNumber(aliceNumber);
            const bobFlip = parseInt(sessionStorage.getItem(`session_${sessionId}_bobFlip`));
            const finalFlip = xorFlips(aliceFlip, bobFlip);

            return `
                <h1>Final Result (Verified)</h1>
                <p>Their number: ${aliceNumber}</p>
                <p>✓ SHA256("${aliceNumber}") == ${computedHash}</p>
                <p>Your partner's flip: ${flipToHtml(aliceFlip)}</p>
                <p>Your flip: ${flipToHtml(bobFlip)}</p>
                <h2>Combined Result: ${flipToHtml(finalFlip)}</h2>
            `;
        }

        async function render() {
            const params = parseUrlParams();
            const app = document.getElementById('app');

            if (params.aliceNumber && params.sessionId) {
                app.innerHTML = await handleReveal(params.sessionId, params.aliceNumber);
            } else if (params.bobFlip && params.sessionId) {
                app.innerHTML = handleAliceSeeBobFlip(params.sessionId, params.bobFlip);
            } else if (params.sessionId && params.hash) {
                app.innerHTML = handleBob(params.sessionId, params.hash);
            } else {
                app.innerHTML = showLanding();
            }
        }

        window.bobFlip = bobFlip;
        window.startCoinFlip = startCoinFlip;
        window.addEventListener('hashchange', render);
        render();
    </script>
</body>
</html>
